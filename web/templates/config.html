<!-- Template pour la configuration -->
<div class="config-management">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Configuration</h2>
        <div class="flex gap-3">
            <button class="btn btn-secondary" id="debug-cache">üîç Debug Cache</button>
            <button class="btn btn-secondary" id="test-config">üß™ Tester</button>
            <button class="btn btn-primary" id="save-config">üíæ Enregistrer</button>
        </div>
    </div>
    
    <!-- Configuration Home Assistant -->
    <div class="card mb-6">
        <div class="card-header">
            <h3 class="card-title">Home Assistant</h3>
            <div class="flex items-center gap-2">
                <div class="status-dot" id="ha-status"></div>
                <span class="text-sm" id="ha-status-text">Chargement...</span>
            </div>
        </div>
        <div class="card-body">
            <form id="ha-config-form" autocomplete="off">
                <!-- Champ username cach√© pour l'accessibilit√© des formulaires de mot de passe -->
                <input type="text" name="username" style="display: none;" autocomplete="username" readonly>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label class="form-label required">URL Home Assistant</label>
                        <input type="url" class="form-input" id="ha-url" name="ha-url"
                               placeholder="http://homeassistant.local:8123" 
                               autocomplete="url" required>
                        <p class="form-help">URL compl√®te de votre instance Home Assistant</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">Token d'acc√®s</label>
                        <div class="input-group">
                            <input type="password" class="form-input" id="ha-token" name="ha-token"
                                   placeholder="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..." 
                                   autocomplete="current-password" required>
                            <button class="btn btn-secondary" id="toggle-token" type="button">üëÅÔ∏è</button>
                        </div>
                        <p class="form-help">
                            Token d'acc√®s long terme g√©n√©r√© dans Home Assistant
                            <a href="#" class="text-primary" id="token-help">Comment obtenir ?</a>
                        </p>
                    </div>
                </div>
            </form>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div class="form-group">
                    <label class="form-label">Timeout (secondes)</label>
                    <input type="number" class="form-input" id="ha-timeout" 
                           value="10" min="5" max="60">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Retry attempts</label>
                    <input type="number" class="form-input" id="ha-retries" 
                           value="3" min="1" max="10">
                </div>
                
                <div class="form-group">
                    <label class="form-label">SSL Verify</label>
                    <select class="form-input" id="ha-ssl-verify">
                        <option value="true">Activ√©</option>
                        <option value="false">D√©sactiv√©</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration serveur MCP -->
    <div class="card mb-6">
        <div class="card-header">
            <h3 class="card-title">Serveur MCP</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                    <label class="form-label">Port d'√©coute</label>
                    <input type="number" class="form-input" id="server-port" 
                           value="8080" min="1024" max="65535">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Host</label>
                    <input type="text" class="form-input" id="server-host" 
                           value="0.0.0.0" placeholder="0.0.0.0">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Max sessions</label>
                    <input type="number" class="form-input" id="max-sessions" 
                           value="10" min="1" max="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Session timeout (minutes)</label>
                    <input type="number" class="form-input" id="session-timeout" 
                           value="30" min="5" max="480">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration base de donn√©es -->
    <div class="card mb-6">
        <div class="card-header">
            <h3 class="card-title">Base de donn√©es</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group">
                    <label class="form-label">Fichier base de donn√©es</label>
                    <input type="text" class="form-input" id="db-file" 
                           value="bridge_data.db" readonly>
                    <p class="form-help">Chemin vers le fichier SQLite</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Retention logs (jours)</label>
                    <input type="number" class="form-input" id="log-retention" 
                           value="30" min="1" max="365">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Auto-cleanup</label>
                    <select class="form-input" id="auto-cleanup">
                        <option value="true">Activ√©</option>
                        <option value="false">D√©sactiv√©</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Backup automatique</label>
                    <select class="form-input" id="auto-backup">
                        <option value="true">Activ√©</option>
                        <option value="false">D√©sactiv√©</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Configuration cache -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Cache et performances</h3>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-group">
                    <label class="form-label">Cache TTL (secondes)</label>
                    <input type="number" class="form-input" id="cache-ttl" 
                           value="300" min="60" max="3600">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Max cache entries</label>
                    <input type="number" class="form-input" id="cache-max-entries" 
                           value="1000" min="100" max="10000">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Circuit breaker threshold</label>
                    <input type="number" class="form-input" id="circuit-threshold" 
                           value="5" min="3" max="20">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'aide pour le token -->
<div id="token-help-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Comment obtenir un token Home Assistant</h3>
            <button class="modal-close" id="close-token-help">‚úï</button>
        </div>
        <div class="modal-body">
            <ol class="list-decimal list-inside space-y-2 text-sm">
                <li>Connectez-vous √† votre interface Home Assistant</li>
                <li>Cliquez sur votre profil utilisateur (en bas √† gauche)</li>
                <li>Descendez jusqu'√† la section "Tokens d'acc√®s long terme"</li>
                <li>Cliquez sur "Cr√©er un token"</li>
                <li>Donnez un nom au token (ex: "MCP Bridge")</li>
                <li>Copiez le token g√©n√©r√© et collez-le dans le champ ci-dessus</li>
            </ol>
            <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400">
                <p class="text-sm text-yellow-700">
                    ‚ö†Ô∏è Attention : Ce token donne un acc√®s complet √† votre Home Assistant. 
                    Gardez-le secret et s√©curis√©.
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" id="token-help-ok">Compris</button>
        </div>
    </div>
</div>

<script>
class ConfigManager {
    constructor() {
        console.log('üöÄ ConfigManager - Initialisation...');
        this.init();
    }
    
    init() {
        console.log('üîß ConfigManager - init() appel√©');
        console.log('üåê window.secureCache disponible:', !!window.secureCache);
        
        this.loadConfiguration();
        this.setupEventListeners();
        this.checkHAStatus();
        
        console.log('‚úÖ ConfigManager - Initialisation termin√©e');
    }
    
    setupEventListeners() {
        console.log('üéØ Configuration event listeners...');
        
        // Boutons principaux
        document.getElementById('test-config').addEventListener('click', () => {
            this.testConfiguration();
        });
        
        document.getElementById('save-config').addEventListener('click', () => {
            this.saveConfiguration();
        });
        
        // Bouton debug cache
        document.getElementById('debug-cache').addEventListener('click', () => {
            this.debugCache();
        });
        
        // Toggle password
        document.getElementById('toggle-token').addEventListener('click', () => {
            this.toggleTokenVisibility();
        });
        
        // Aide token
        document.getElementById('token-help').addEventListener('click', (e) => {
            e.preventDefault();
            this.showTokenHelp();
        });
        
        document.getElementById('close-token-help').addEventListener('click', () => {
            this.hideTokenHelp();
        });
        
        document.getElementById('token-help-ok').addEventListener('click', () => {
            this.hideTokenHelp();
        });
        
        // üîê Sauvegarde automatique dans cache s√©curis√©
        this.setupAutoSave();
        
        // Validation en temps r√©el
        document.getElementById('ha-url').addEventListener('input', () => {
            this.validateHAUrl();
        });
    }
    
    /**
     * üîê Configure la sauvegarde automatique dans le cache s√©curis√©
     */
    setupAutoSave() {
        console.log('üîß Configuration auto-sauvegarde...');
        
        const haUrlInput = document.getElementById('ha-url');
        const haTokenInput = document.getElementById('ha-token');
        
        console.log('üéØ √âl√©ments trouv√©s:', {
            haUrlInput: !!haUrlInput,
            haTokenInput: !!haTokenInput
        });
        
        if (!haUrlInput || !haTokenInput) {
            console.error('‚ùå Impossible de configurer auto-sauvegarde - √©l√©ments manquants');
            return;
        }
        
        // Sauvegarder les modifications automatiquement avec debounce
        let saveTimeout;
        const autoSave = (source) => {
            console.log(`üîÑ Auto-save d√©clench√© par: ${source}`);
            
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const url = haUrlInput.value.trim();
                const token = haTokenInput.value.trim();
                
                console.log('üíæ Auto-save - Donn√©es √† sauvegarder:', {
                    url: url,
                    token: token ? `${token.substring(0, 10)}...` : 'vide',
                    cacheAvailable: !!window.secureCache
                });
                
                if (url && token && window.secureCache) {
                    const storeResult = window.cacheHA({
                        url: url,
                        token: token,
                        name: 'auto_save'
                    });
                    console.log('üîê Auto-sauvegarde config HA - R√©sultat:', storeResult);
                } else {
                    console.log('‚ö†Ô∏è Auto-save ignor√© - donn√©es incompl√®tes ou cache indisponible');
                }
            }, 1000); // Attendre 1 seconde apr√®s la derni√®re modification
        };
        
        haUrlInput.addEventListener('input', () => autoSave('url-input'));
        haTokenInput.addEventListener('input', () => autoSave('token-input'));
        haUrlInput.addEventListener('blur', () => autoSave('url-blur'));
        haTokenInput.addEventListener('blur', () => autoSave('token-blur'));
        
        console.log('‚úÖ Auto-sauvegarde configur√©e');
    }
    
    async loadConfiguration() {
        console.group('üìã loadConfiguration - D√©but');
        
        try {
            // üîê Attendre que le cache s√©curis√© soit disponible
            let cachedHA = null;
            let retries = 0;
            const maxRetries = 10;
            
            console.log('‚è≥ Attente du cache s√©curis√©...');
            while (retries < maxRetries && !window.secureCache) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retries++;
                console.log(`Tentative ${retries}/${maxRetries} - Cache disponible:`, !!window.secureCache);
            }
            
            if (window.secureCache) {
                console.log('‚úÖ Cache s√©curis√© disponible');
                window.secureCache.debug();
                cachedHA = window.getHA();
                console.log('üîê Cache s√©curis√© disponible, donn√©es HA:', cachedHA);
            } else {
                console.warn('‚ö†Ô∏è Cache s√©curis√© non disponible apr√®s 1 seconde');
            }
            
            console.log('üì° R√©cup√©ration config serveur...');
            const response = await fetch('/api/config');
            const config = await response.json();
            console.log('üì° Config serveur re√ßue:', config);
            
            // Configuration Home Assistant
            if (config.homeassistant) {
                console.group('üè† Traitement config Home Assistant');
                
                // Utiliser le cache s√©curis√© en priorit√© pour les donn√©es sensibles
                const haUrl = cachedHA?.url || config.homeassistant.url || '';
                const haToken = cachedHA?.token || config.homeassistant.token || '';
                
                console.log('üîß Sources des donn√©es:', { 
                    fromCache: !!cachedHA?.url, 
                    fromServer: !!config.homeassistant.url,
                    finalUrl: haUrl,
                    finalToken: haToken ? `${haToken.substring(0, 10)}...` : 'vide'
                });
                
                // V√©rifier que les √©l√©ments DOM existent
                const urlElement = document.getElementById('ha-url');
                const tokenElement = document.getElementById('ha-token');
                
                console.log('üéØ √âl√©ments DOM:', {
                    urlElement: !!urlElement,
                    tokenElement: !!tokenElement
                });
                
                if (urlElement && tokenElement) {
                    console.log('üìù Remplissage des champs...');
                    urlElement.value = haUrl;
                    tokenElement.value = haToken;
                    
                    console.log('‚úÖ Champs remplis:', {
                        url: urlElement.value,
                        token: tokenElement.value ? `${tokenElement.value.substring(0, 10)}...` : 'vide'
                    });
                } else {
                    console.error('‚ùå √âl√©ments DOM non trouv√©s');
                }
                
                document.getElementById('ha-timeout').value = config.homeassistant.timeout || 10;
                document.getElementById('ha-retries').value = config.homeassistant.retries || 3;
                document.getElementById('ha-ssl-verify').value = config.homeassistant.ssl_verify ? 'true' : 'false';
                
                // Stocker dans le cache s√©curis√© si nouvelles donn√©es disponibles
                if (haUrl && haToken && window.secureCache && !cachedHA) {
                    console.log('üíæ Stockage dans cache s√©curis√©...');
                    const storeResult = window.cacheHA({
                        url: haUrl,
                        token: haToken,
                        name: 'config_load'
                    });
                    console.log('ÔøΩ R√©sultat stockage:', storeResult);
                }
                
                console.groupEnd();
            }
            
            // Configuration serveur
            if (config.server) {
                document.getElementById('server-port').value = config.server.port || 8080;
                document.getElementById('server-host').value = config.server.host || '0.0.0.0';
                document.getElementById('max-sessions').value = config.server.max_sessions || 10;
                document.getElementById('session-timeout').value = config.server.session_timeout || 30;
            }
            
            // Configuration base de donn√©es
            if (config.database) {
                document.getElementById('db-file').value = config.database.file || 'bridge_data.db';
                document.getElementById('log-retention').value = config.database.log_retention || 30;
                document.getElementById('auto-cleanup').value = config.database.auto_cleanup ? 'true' : 'false';
                document.getElementById('auto-backup').value = config.database.auto_backup ? 'true' : 'false';
            }
            
            // Configuration cache
            if (config.cache) {
                document.getElementById('cache-ttl').value = config.cache.ttl || 300;
                document.getElementById('cache-max-entries').value = config.cache.max_entries || 1000;
                document.getElementById('circuit-threshold').value = config.cache.circuit_threshold || 5;
            }
            
        } catch (error) {
            console.error('Erreur chargement configuration:', error);
            window.showToast('Erreur lors du chargement de la configuration', 'error');
        }
    }
    
    async saveConfiguration() {
        try {
            const haUrl = document.getElementById('ha-url').value;
            const haToken = document.getElementById('ha-token').value;
            
            const config = {
                homeassistant: {
                    url: haUrl,
                    token: haToken,
                    timeout: parseInt(document.getElementById('ha-timeout').value),
                    retries: parseInt(document.getElementById('ha-retries').value),
                    ssl_verify: document.getElementById('ha-ssl-verify').value === 'true'
                },
                server: {
                    port: parseInt(document.getElementById('server-port').value),
                    host: document.getElementById('server-host').value,
                    max_sessions: parseInt(document.getElementById('max-sessions').value),
                    session_timeout: parseInt(document.getElementById('session-timeout').value)
                },
                database: {
                    file: document.getElementById('db-file').value,
                    log_retention: parseInt(document.getElementById('log-retention').value),
                    auto_cleanup: document.getElementById('auto-cleanup').value === 'true',
                    auto_backup: document.getElementById('auto-backup').value === 'true'
                },
                cache: {
                    ttl: parseInt(document.getElementById('cache-ttl').value),
                    max_entries: parseInt(document.getElementById('cache-max-entries').value),
                    circuit_threshold: parseInt(document.getElementById('circuit-threshold').value)
                }
            };
            
            // üîê Stocker les donn√©es HA sensibles dans le cache s√©curis√©
            if (haUrl && haToken && window.secureCache) {
                window.cacheHA({
                    url: haUrl,
                    token: haToken,
                    name: 'config_save'
                });
                console.log('üîê Config HA sauvegard√©e dans cache s√©curis√©');
            }
            
            const response = await fetch('/api/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            });
            
            if (response.ok) {
                window.showToast('Configuration sauvegard√©e avec succ√®s', 'success');
                this.checkHAStatus();
            } else {
                const error = await response.json();
                window.showToast(`Erreur: ${error.detail || 'Erreur inconnue'}`, 'error');
            }
            
        } catch (error) {
            console.error('Erreur sauvegarde configuration:', error);
            window.showToast('Erreur lors de la sauvegarde', 'error');
        }
    }
    
    async testConfiguration() {
        try {
            const url = document.getElementById('ha-url').value;
            const token = document.getElementById('ha-token').value;
            
            if (!url || !token) {
                window.showToast('Veuillez remplir l\'URL et le token Home Assistant', 'warning');
                return;
            }
            
            const response = await fetch('/api/config/test-homeassistant', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    url: url,
                    token: token
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                window.showToast('Connexion Home Assistant r√©ussie !', 'success');
                this.updateHAStatus(true, result.message);
            } else {
                window.showToast(`Test √©chou√©: ${result.message}`, 'error');
                this.updateHAStatus(false, result.message);
            }
            
        } catch (error) {
            console.error('Erreur test configuration:', error);
            window.showToast('Erreur lors du test de connexion', 'error');
            this.updateHAStatus(false, 'Erreur de connexion');
        }
    }
    
    async checkHAStatus() {
        try {
            const response = await fetch('/api/config/homeassistant-status');
            const status = await response.json();
            
            this.updateHAStatus(status.connected, status.message);
            
        } catch (error) {
            console.error('Erreur v√©rification statut HA:', error);
            this.updateHAStatus(false, 'Statut inconnu');
        }
    }
    
    updateHAStatus(connected, message) {
        const statusDot = document.getElementById('ha-status');
        const statusText = document.getElementById('ha-status-text');
        
        // V√©rifier que les √©l√©ments existent avant de les modifier
        if (!statusDot || !statusText) {
            console.log('√âl√©ments de statut HA non trouv√©s, probablement sur une autre page');
            return;
        }
        
        if (connected) {
            statusDot.className = 'status-dot status-online';
            statusText.textContent = message || 'Connect√©';
            statusText.className = 'text-sm text-green-600';
        } else {
            statusDot.className = 'status-dot status-error';
            statusText.textContent = message || 'D√©connect√©';
            statusText.className = 'text-sm text-red-600';
        }
    }
    
    toggleTokenVisibility() {
        const tokenInput = document.getElementById('ha-token');
        const toggleBtn = document.getElementById('toggle-token');
        
        if (tokenInput.type === 'password') {
            tokenInput.type = 'text';
            toggleBtn.textContent = 'üôà';
        } else {
            tokenInput.type = 'password';
            toggleBtn.textContent = 'üëÅÔ∏è';
        }
    }
    
    showTokenHelp() {
        document.getElementById('token-help-modal').classList.remove('hidden');
    }
    
    hideTokenHelp() {
        document.getElementById('token-help-modal').classList.add('hidden');
    }
    
    validateHAUrl() {
        const urlInput = document.getElementById('ha-url');
        const url = urlInput.value;
        
        if (url && !url.match(/^https?:\/\/.+/)) {
            urlInput.classList.add('border-red-500');
        } else {
            urlInput.classList.remove('border-red-500');
        }
    }
    
    /**
     * üîç Debug du cache s√©curis√©
     */
    debugCache() {
        console.group('üîç DEBUG CACHE S√âCURIS√â');
        
        console.log('üåê Cache disponible:', !!window.secureCache);
        if (window.secureCache) {
            console.log('üìä Status cache:', window.secureCache.getStatus());
            window.secureCache.debug();
            
            const haData = window.getHA();
            console.log('üè† Donn√©es HA en cache:', haData);
            
            // Test de stockage/r√©cup√©ration
            console.log('üß™ Test stockage/r√©cup√©ration...');
            const testData = {
                url: 'http://test.local:8123',
                token: 'test_token_123',
                name: 'debug_test'
            };
            
            const storeResult = window.cacheHA(testData);
            console.log('üíæ R√©sultat stockage test:', storeResult);
            
            const retrieveResult = window.getHA();
            console.log('üîì R√©sultat r√©cup√©ration test:', retrieveResult);
        } else {
            console.error('‚ùå Cache s√©curis√© non disponible');
        }
        
        // √âtat des champs DOM
        const urlField = document.getElementById('ha-url');
        const tokenField = document.getElementById('ha-token');
        
        console.log('üéØ √âtat des champs DOM:', {
            urlField: !!urlField,
            urlValue: urlField?.value || 'N/A',
            tokenField: !!tokenField,
            tokenValue: tokenField?.value ? `${tokenField.value.substring(0, 10)}...` : 'N/A'
        });
        
        console.groupEnd();
        
        // Afficher une alerte avec un r√©sum√©
        const summary = window.secureCache ? 
            `Cache disponible ‚úÖ\nDonn√©es HA: ${window.getHA() ? 'pr√©sentes' : 'absentes'}\nTaille cache: ${window.secureCache.encrypted.size}` :
            'Cache non disponible ‚ùå';
            
        alert(`Debug Cache S√©curis√©\n\n${summary}\n\nVoir console pour d√©tails complets`);
    }
}

// Initialiser le gestionnaire de configuration
const configManager = new ConfigManager();
</script>
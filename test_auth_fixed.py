#!/usr/bin/env python3
"""
Script de test pour le syst√®me d'authentification - Version corrig√©e avec emails uniques
"""

import asyncio
import aiohttp
import json
import logging
import sys
import time
from datetime import datetime

# Configuration du logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Configuration du serveur
BASE_URL = "http://localhost:8080"


class AuthTester:
    """Testeur pour l'API d'authentification"""
    
    def __init__(self):
        self.session = None
        self.access_token = None
        self.refresh_token = None
        self.user_id = None
        # G√©n√©rer un timestamp unique pour les tests
        self.timestamp = int(time.time())
        self.unique_username = f"testuser_{self.timestamp}"
        self.unique_email = f"test_{self.timestamp}@example.com"
    
    async def __aenter__(self):
        self.session = aiohttp.ClientSession()
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if self.session:
            await self.session.close()
    
    async def test_health(self):
        """Test du health check"""
        logger.info("üè• Testing health endpoint...")
        
        try:
            async with self.session.get(f"{BASE_URL}/health") as response:
                if response.status == 200:
                    data = await response.json()
                    logger.info(f"‚úÖ Health check OK: {data}")
                    return True
                else:
                    logger.error(f"‚ùå Health check failed: {response.status}")
                    return False
        except Exception as e:
            logger.error(f"‚ùå Health check error: {e}")
            return False
    
    async def test_unauthorized_access(self):
        """Test d'acc√®s non autoris√©"""
        logger.info("üõ°Ô∏è Testing unauthorized access...")
        
        try:
            async with self.session.get(f"{BASE_URL}/auth/me") as response:
                if response.status == 401:
                    logger.info("‚úÖ Unauthorized access correctly blocked")
                    return True
                else:
                    logger.error(f"‚ùå Expected 401, got {response.status}")
                    return False
        except Exception as e:
            logger.error(f"‚ùå Unauthorized access error: {e}")
            return False
    
    async def test_invalid_credentials(self):
        """Test avec des identifiants invalides"""
        logger.info("üö´ Testing invalid credentials...")
        
        login_data = {
            "username": "invalid_user",
            "password": "wrong_password"
        }
        
        try:
            async with self.session.post(
                f"{BASE_URL}/auth/login",
                json=login_data
            ) as response:
                
                if response.status == 401:
                    logger.info("‚úÖ Invalid credentials correctly rejected")
                    return True
                else:
                    data = await response.json()
                    logger.error(f"‚ùå Expected 401, got {response.status}: {data}")
                    return False
                    
        except Exception as e:
            logger.error(f"‚ùå Invalid credentials error: {e}")
            return False
    
    async def test_register(self, username=None, password="TestPass123!", email=None):
        """Test d'inscription avec email unique"""
        username = username or self.unique_username
        email = email or self.unique_email
        
        logger.info(f"üìù Testing user registration: {username}")
        
        user_data = {
            "username": username,
            "password": password,
            "email": email,
            "full_name": "Test User"
        }
        
        try:
            async with self.session.post(
                f"{BASE_URL}/auth/register",
                json=user_data
            ) as response:
                
                data = await response.json()
                
                if response.status == 200:
                    self.user_id = data.get("id")
                    logger.info(f"‚úÖ Registration successful: {data}")
                    return True
                else:
                    logger.error(f"‚ùå Registration failed ({response.status}): {data}")
                    return False
                    
        except Exception as e:
            logger.error(f"‚ùå Registration error: {e}")
            return False
    
    async def test_login(self, username=None, password="TestPass123!"):
        """Test de connexion"""
        username = username or self.unique_username
        logger.info(f"üîë Testing user login: {username}")
        
        login_data = {
            "username": username,
            "password": password
        }
        
        try:
            async with self.session.post(
                f"{BASE_URL}/auth/login",
                json=login_data
            ) as response:
                
                data = await response.json()
                
                if response.status == 200:
                    self.access_token = data.get("access_token")
                    self.refresh_token = data.get("refresh_token")
                    logger.info(f"‚úÖ Login successful")
                    return True
                else:
                    logger.error(f"‚ùå Login failed ({response.status}): {data}")
                    return False
                    
        except Exception as e:
            logger.error(f"‚ùå Login error: {e}")
            return False
    
    async def test_user_info(self):
        """Test d'obtention des informations utilisateur"""
        logger.info("üë§ Testing user info endpoint...")
        
        if not self.access_token:
            logger.error("‚ùå No access token available")
            return False
        
        headers = {"Authorization": f"Bearer {self.access_token}"}
        
        try:
            async with self.session.get(
                f"{BASE_URL}/auth/me",
                headers=headers
            ) as response:
                
                if response.status == 200:
                    data = await response.json()
                    logger.info(f"‚úÖ User info retrieved: {data}")
                    return True
                else:
                    data = await response.json()
                    logger.error(f"‚ùå User info failed ({response.status}): {data}")
                    return False
                    
        except Exception as e:
            logger.error(f"‚ùå User info error: {e}")
            return False
    
    async def test_user_sessions(self):
        """Test d'obtention des sessions utilisateur"""
        logger.info("üìã Testing user sessions endpoint...")
        
        if not self.access_token:
            logger.error("‚ùå No access token available")
            return False
        
        headers = {"Authorization": f"Bearer {self.access_token}"}
        
        try:
            async with self.session.get(
                f"{BASE_URL}/auth/sessions",
                headers=headers
            ) as response:
                
                if response.status == 200:
                    data = await response.json()
                    logger.info(f"‚úÖ User sessions retrieved: {len(data)} sessions")
                    return True
                else:
                    data = await response.json()
                    logger.error(f"‚ùå User sessions failed ({response.status}): {data}")
                    return False
                    
        except Exception as e:
            logger.error(f"‚ùå User sessions error: {e}")
            return False
    
    async def test_token_refresh(self):
        """Test de rafra√Æchissement du token"""
        logger.info("üîÑ Testing token refresh...")
        
        if not self.refresh_token:
            logger.error("‚ùå No refresh token available")
            return False
        
        refresh_data = {"refresh_token": self.refresh_token}
        
        try:
            async with self.session.post(
                f"{BASE_URL}/auth/refresh",
                json=refresh_data
            ) as response:
                
                data = await response.json()
                
                if response.status == 200:
                    # Mettre √† jour les tokens
                    self.access_token = data.get("access_token")
                    self.refresh_token = data.get("refresh_token")
                    logger.info(f"‚úÖ Token refresh successful")
                    return True
                else:
                    logger.error(f"‚ùå Token refresh failed ({response.status}): {data}")
                    return False
                    
        except Exception as e:
            logger.error(f"‚ùå Token refresh error: {e}")
            return False
    
    async def test_logout(self):
        """Test de d√©connexion"""
        logger.info("üö™ Testing user logout...")
        
        if not self.access_token:
            logger.error("‚ùå No access token available")
            return False
        
        headers = {"Authorization": f"Bearer {self.access_token}"}
        
        try:
            async with self.session.post(
                f"{BASE_URL}/auth/logout",
                headers=headers
            ) as response:
                
                if response.status == 200:
                    data = await response.json()
                    logger.info(f"‚úÖ Logout successful: {data}")
                    return True
                else:
                    data = await response.json()
                    logger.error(f"‚ùå Logout failed ({response.status}): {data}")
                    return False
                    
        except Exception as e:
            logger.error(f"‚ùå Logout error: {e}")
            return False

async def run_tests():
    """Ex√©cute tous les tests d'authentification"""
    logger.info("üß™ Starting authentication tests...")
    
    # Compteurs des r√©sultats
    passed = 0
    failed = 0
    results = []
    
    async with AuthTester() as tester:
        
        # Test 1: Health Check
        if await tester.test_health():
            passed += 1
            results.append("‚úÖ PASS     Health Check")
        else:
            failed += 1
            results.append("‚ùå FAIL     Health Check")
        
        # Test 2: Unauthorized Access
        if await tester.test_unauthorized_access():
            passed += 1
            results.append("‚úÖ PASS     Unauthorized Access")
        else:
            failed += 1
            results.append("‚ùå FAIL     Unauthorized Access")
        
        # Test 3: Invalid Credentials
        if await tester.test_invalid_credentials():
            passed += 1
            results.append("‚úÖ PASS     Invalid Credentials")
        else:
            failed += 1
            results.append("‚ùå FAIL     Invalid Credentials")
        
        # Test 4: Registration
        if await tester.test_register():
            passed += 1
            results.append("‚úÖ PASS     Registration")
        else:
            failed += 1
            results.append("‚ùå FAIL     Registration")
        
        # Test 5: Login
        if await tester.test_login():
            passed += 1
            results.append("‚úÖ PASS     Login")
        else:
            failed += 1
            results.append("‚ùå FAIL     Login")
        
        # Test 6: User Info
        if await tester.test_user_info():
            passed += 1
            results.append("‚úÖ PASS     User Info")
        else:
            failed += 1
            results.append("‚ùå FAIL     User Info")
        
        # Test 7: User Sessions
        if await tester.test_user_sessions():
            passed += 1
            results.append("‚úÖ PASS     User Sessions")
        else:
            failed += 1
            results.append("‚ùå FAIL     User Sessions")
        
        # Test 8: Token Refresh
        if await tester.test_token_refresh():
            passed += 1
            results.append("‚úÖ PASS     Token Refresh")
        else:
            failed += 1
            results.append("‚ùå FAIL     Token Refresh")
        
        # Test 9: User Info (apr√®s refresh)
        if await tester.test_user_info():
            passed += 1
            results.append("‚úÖ PASS     User Info (after refresh)")
        else:
            failed += 1
            results.append("‚ùå FAIL     User Info (after refresh)")
        
        # Test 10: Logout
        if await tester.test_logout():
            passed += 1
            results.append("‚úÖ PASS     Logout")
        else:
            failed += 1
            results.append("‚ùå FAIL     Logout")
    
    # Affichage des r√©sultats
    logger.info("")
    logger.info("==================================================")
    logger.info("üìä TEST RESULTS SUMMARY")
    logger.info("==================================================")
    
    for result in results:
        logger.info(result)
    
    logger.info("==================================================")
    total = passed + failed
    percentage = (passed / total) * 100 if total > 0 else 0
    logger.info(f"üìà Results: {passed}/{total} tests passed ({percentage:.1f}%)")
    
    if failed > 0:
        logger.error(f"‚ö†Ô∏è {failed} tests failed")
        return False
    else:
        logger.info("üéâ All tests passed!")
        return True

if __name__ == "__main__":
    print("üß™ HTTP-MCP Bridge Authentication Test Suite")
    print("==================================================")
    print("Make sure the server is running on http://localhost:8080")
    print("==================================================")
    print()
    
    success = asyncio.run(run_tests())
    sys.exit(0 if success else 1)